<?php

/**
 * @file
 * Contains sdv_gis.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function sdv_gis_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the sdv_gis module.
    case 'help.page.sdv_gis':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('TODO Module description here ...') . '</p>';
      return $output;

    default:
  }
}

function sdv_gis_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
	file_put_contents('/var/www/html/drupal/published/rob','$form_id='.$form_id);
    if ($form_id == 'sdv_gis_entity_edit_form') {
        $form['#attached']['library'][] = 'sdv_gis/sdv_gis_edit';
/*
        $xml=simplexml_load_file('https://geodata.rivm.nl/geoserver/wms?VERSION=1.1.1&REQUEST=GetCapabilities');
        $wms='';
        if ($xml->Capability->Layer) foreach ($xml->Capability->Layer->children() as $layer) {
            $name=$layer->Name;
            $title=$layer->Title;
            if ($name!='') {
                $wms.=($wms==''?'':'|').$name.'='.$title;
            }
        }
        $form['#attached']['drupalSettings']['gis_ia']['wms'] = $wms;
        $xml=simplexml_load_file('https://acceptatie.geodata.rivm.nl/geoserver/wms?VERSION=1.1.1&REQUEST=GetCapabilities');
        $wms='';
        if ($xml->Capability->Layer) foreach ($xml->Capability->Layer->children() as $layer) {
            $name=$layer->Name;
            $title=$layer->Title;
            if ($name!='') {
                $wms.=($wms==''?'':'|').$name.'='.$title;
            }
        }
        $form['#attached']['drupalSettings']['gis_ia']['wmsacceptatie'] = $wms;

		$readFromServer=true; $fname=__DIR__.'/datarivmnl.def';
		if (file_exists($fname)) {$readFromServer=false;}
		if ($readFromServer) {
			$xml=file_get_contents('https://data.rivm.nl/geonetwork/srv/dut/csw-ngr?service=CSW&resultType=results&version=2.0.2&request=GetRecords&MaxRecords=1000');
			$xml=preg_replace("/(<\/?)(\w+):([^>]*>)/", "$1$2$3", $xml);
			$xml=new SimpleXMLElement($xml);
			$wms='';
			foreach ($xml->cswSearchResults->children() as $layer) {
				$layerXML=file_get_contents('https://data.rivm.nl/geonetwork/srv/dut/csw-ngr?request=GetRecordById&service=CSW&version=2.0.2&elementSetName=full&id='.$layer->dcidentifier);
				$layerXML=preg_replace("/(<\/?)(\w+):([^>]*>)/", "$1$2$3", $layerXML);
				$layerXML=new SimpleXMLElement($layerXML);
				if ($layer->dctitle!='') {
					foreach ($layerXML->cswRecord->children() as $key=>$value) if ($key=='dcURI' && $value['protocol']=='OGC:WMS') {
						$server=$value[0];
						if (substr($server,-1,1)=='?') {$server=substr($server,0,strlen($server)-1);}
						if (substr($server,-1,1)=='/') {$server=substr($server,0,strlen($server)-1);}
						if ($server!='' && $value['name']!='') {
							$wms.=($wms==''?'':'|');
							$wms.=$server.'='.$layer->dctitle.'='.$value['name'];
						}
					}
				}
			}
			file_put_contents($fname,$wms);
		} else {
			$wms=file_get_contents($fname);
		}
        $form['#attached']['drupalSettings']['gis_ia']['datarivmnl'] = $wms;
*/	
    }
}
